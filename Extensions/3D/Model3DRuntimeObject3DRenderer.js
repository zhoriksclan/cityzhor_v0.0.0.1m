var gdjs;(function(a){const s=1/(1<<16),g=i=>{i.metalness&&(i.metalness=0)},f=i=>{const t=i;if(!!t.material)if(Array.isArray(t.material))for(let e=0;e<t.material.length;e++)g(t.material[e]);else g(t.material)},b=i=>i.traverse(f),M=i=>{const t=new THREE.MeshBasicMaterial;return i.color&&(t.color=i.color),i.map&&(t.map=i.map),t},D=i=>{const t=i;if(!!t.material)if(Array.isArray(t.material))for(let e=0;e<t.material.length;e++)t.material[e]=M(t.material[e]);else t.material=M(t.material)},T=i=>i.traverse(D);class j extends a.RuntimeObject3DRenderer{constructor(t,e){const r=e.getGame().getModel3DManager().getModel(t._modelResourceName),n=new THREE.Group,h=new THREE.Group;h.rotation.order="ZYX",h.add(n);super(t,e,h);this._model3DRuntimeObject=t,this._threeObject=n,this._originalModel=r,this._modelOriginPoint=[0,0,0],this.updateSize(),this.updatePosition(),this.updateRotation(),this._animationMixer=new THREE.AnimationMixer(n),this._action=null}updateAnimation(t){this._animationMixer.update(t)}updatePosition(){const t=this.getOriginPoint(),e=this.getCenterPoint();this.get3DRendererObject().position.set(this._object.getX()-this._object.getWidth()*(t[0]-e[0]),this._object.getY()-this._object.getHeight()*(t[1]-e[1]),this._object.getZ()-this._object.getDepth()*(t[2]-e[2]))}getOriginPoint(){return this._model3DRuntimeObject._originPoint||this._modelOriginPoint}getCenterPoint(){return this._model3DRuntimeObject._centerPoint||this._modelOriginPoint}_updateDefaultTransformation(t,e,r,n,h,R,p,l){t.rotation.set(a.toRad(e),a.toRad(r),a.toRad(n)),t.updateMatrixWorld(!0);const o=new THREE.Box3().setFromObject(t);!this._model3DRuntimeObject._originPoint&&o.expandByPoint(new THREE.Vector3(0,0,0));const m=o.max.x-o.min.x,c=o.max.y-o.min.y,d=o.max.z-o.min.z;this._modelOriginPoint[0]=m<s?0:-o.min.x/m,this._modelOriginPoint[1]=c<s?0:-o.min.y/c,this._modelOriginPoint[2]=d<s?0:-o.min.z/d,this._modelOriginPoint[1]=1-this._modelOriginPoint[1];const u=this._model3DRuntimeObject._centerPoint;u&&t.position.set(-(o.min.x+m*u[0]),-(o.min.y+c*(1-u[1])),-(o.min.z+d*u[2])),t.scale.set(1,1,1),t.rotation.set(a.toRad(e),a.toRad(r),a.toRad(n));const A=m<s?1:1/m,H=c<s?1:1/c,P=d<s?1:1/d,O=new THREE.Matrix4;if(O.makeScale(A,-H,P),t.updateMatrix(),t.applyMatrix4(O),l){const x=m<s?Number.POSITIVE_INFINITY:h/m,v=c<s?Number.POSITIVE_INFINITY:R/c,I=d<s?Number.POSITIVE_INFINITY:p/d;let _=Math.min(x,v,I);Number.isFinite(_)||(_=1),this._object._setOriginalWidth(_*m),this._object._setOriginalHeight(_*c),this._object._setOriginalDepth(_*d)}}_reloadModel(t,e){this._originalModel=e.getGame().getModel3DManager().getModel(t._modelResourceName)}_updateModel(t,e,r,n,h,R,p){const l=new THREE.Group;l.rotation.order="ZYX";const o=THREE_ADDONS.SkeletonUtils.clone(this._originalModel.scene);l.add(o),this._replaceMaterials(l),this._updateDefaultTransformation(l,t,e,r,n,h,R,p),this.get3DRendererObject().remove(this._threeObject),this.get3DRendererObject().add(l),this._threeObject=l,this._updateShadow(),this._animationMixer=new THREE.AnimationMixer(o);const E=this._model3DRuntimeObject.isAnimationPaused();this._model3DRuntimeObject.setAnimationIndex(this._model3DRuntimeObject.getAnimationIndex()),E&&this.pauseAnimation()}_replaceMaterials(t){this._model3DRuntimeObject._materialType===a.Model3DRuntimeObject.MaterialType.StandardWithoutMetalness?b(t):this._model3DRuntimeObject._materialType===a.Model3DRuntimeObject.MaterialType.Basic&&T(t)}getAnimationCount(){return this._originalModel.animations.length}getAnimationName(t){return this._originalModel.animations[t].name}_updateShadow(){this._threeObject.traverse(t=>{t.castShadow=this._model3DRuntimeObject._isCastingShadow,t.receiveShadow=this._model3DRuntimeObject._isReceivingShadow})}hasAnimationEnded(){return this._action?!this._action.isRunning():!0}animationPaused(){if(!!this._action)return this._action.paused}pauseAnimation(){!this._action||(this._action.paused=!0)}resumeAnimation(){!this._action||(this._action.paused=!1)}playAnimation(t,e){const r=THREE.AnimationClip.findByName(this._originalModel.animations,t);if(!r){console.error(`The GLB file: ${this._model3DRuntimeObject._modelResourceName} doesn't have any animation named: ${t}`);return}const n=this._action;this._action=this._animationMixer.clipAction(r),this._action.reset(),this._action.setLoop(e?THREE.LoopRepeat:THREE.LoopOnce,Number.POSITIVE_INFINITY),this._action.clampWhenFinished=!0,this._action.timeScale=this._model3DRuntimeObject.getAnimationSpeedScale(),n&&n!==this._action&&this._action.crossFadeFrom(n,this._model3DRuntimeObject._crossfadeDuration,!1),this._action.play(),this._animationMixer.update(0)}getAnimationElapsedTime(){return this._action?this._action.time:0}setAnimationElapsedTime(t){this._action&&(this._action.time=t)}setAnimationTimeScale(t){this._action&&(this._action.timeScale=t)}getAnimationDuration(t){const e=THREE.AnimationClip.findByName(this._originalModel.animations,t);return e?e.duration:0}}a.Model3DRuntimeObjectRenderer=j})(gdjs||(gdjs={}));
//# sourceMappingURL=Model3DRuntimeObject3DRenderer.js.map
